<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affichage de Conversation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .conversation {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            position: relative;
        }
        .message-content {
            word-wrap: break-word;
        }
        .message-time {
            font-size: 0.7em;
            color: #777;
            margin-top: 5px;
            display: block;
        }
        .message.sent {
            background-color: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        .message.received {
            background-color: #f1f1f1;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        .message-sender {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        h1 {
            text-align: center;
            color: #333;
        }
    </style>
</head>
<body>
    <h1 id="aaaNAME"></h1>
    <input type="text" id="textIN">
    <button id="btnIN"></button>
    

    <div id="conversation-container" class="conversation">
        <!-- La conversation sera affichée ici -->
    </div>

    <script>
        // Fonction pour afficher la conversation
        function displayconv(messages) {
            const container = document.getElementById('conversation-container');
            container.innerHTML = ''; // Vider le conteneur
            
            // Parcourir tous les messages
            messages.forEach(message => {
                // Créer un élément pour le message
                const messageElement = document.createElement('div');
                
                // Déterminer si le message est envoyé ou reçu (pour cet exemple, on considère "partglm" comme l'autre participant)
                const isReceived = message.by === 'partglm';
                messageElement.className = `message ${isReceived ? 'received' : 'sent'}`;
                
                // Créer le contenu du message
                let messageHTML = '';
                
                // Ajouter le nom de l'expéditeur
                messageHTML += `<div class="message-sender">${message.by}</div>`;
                
                // Ajouter le contenu du message
                messageHTML += `<div class="message-content">${message.msg}</div>`;
                
                // Ajouter l'horodatage
                messageHTML += `<span class="message-time">${message.when}</span>`;
                
                // Définir le HTML du message
                messageElement.innerHTML = messageHTML;
                
                // Ajouter le message au conteneur
                container.appendChild(messageElement);
            });

            const NAME = document.getElementById('aaaNAME')
            NAME.textContent = new URLSearchParams(window.location.search).get('conv')
        }

        async function start () {
            const parameters = new URLSearchParams(window.location.search)
            const result = await fetch('/api/getContentConv', {
                method: 'POST',
                headers: {
                         'Content-Type': 'application/json'
                },
                body: JSON.stringify({param: parameters.get('conv')})
            })
            const data = await result.json()
            
            displayconv(data.content)
        }
        start()

        const socket = io();
        socket.on('isThisYou?', async ({message, id}) => {
            const parameters = new URLSearchParams(window.location.search)
            if (message != parameters.get('conv')) return

            const result = await fetch('/api/getMessage', {
                method: 'POST',
                headers: {
                         'Content-Type': 'application/json'
                },
                body: JSON.stringify({conv: message})
            })
            const data = await result.json()
            
            appendATconv(data.content)
        })
        
        document.getElementById('btnIN').addEventListener('click', async () => {
            const parameters = new URLSearchParams(window.location.search)
            const result = await fetch('/api/sendMessage', {
                method: 'POST',
                headers: {
                         'Content-Type': 'application/json'
                },
                body: JSON.stringify({ msg: document.getElementById('textIN').value, who: parameters.get('user'), conv: parameters.get('conv')})
            })
        })
    </script>
</body>
</html>